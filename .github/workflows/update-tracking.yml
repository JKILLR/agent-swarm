name: Update Task Tracking

on:
  push:
    branches: [ main, develop, 'claude/**' ]
  workflow_dispatch:

jobs:
  update-tracking:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 2  # Need previous commit to detect changes

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml

    - name: Parse commit tags and update tracking
      run: |
        # Get the latest commit message
        COMMIT_MSG=$(git log -1 --pretty=%B)
        echo "Commit message: $COMMIT_MSG"

        # Extract tags
        SWARM=$(echo "$COMMIT_MSG" | grep -oP '\[swarm:\K\w+(?=\])' || true)
        TASK=$(echo "$COMMIT_MSG" | grep -oP '\[task:\K[\w-]+(?=\])' || true)
        STATUS=$(echo "$COMMIT_MSG" | grep -oP '\[status:\K\w+(?=\])' || true)

        if [ -n "$SWARM" ] && [ -n "$TASK" ] && [ -n "$STATUS" ]; then
          echo "Found tracking tags: swarm=$SWARM task=$TASK status=$STATUS"
          python tools/sync_tracking.py "$SWARM" "$TASK" "$STATUS"

          # Check if swarm.yaml was modified
          if git diff --quiet swarms/; then
            echo "No changes to commit"
          else
            echo "Swarm tracking files were updated"
            git config user.name "Agent Swarm Bot"
            git config user.email "bot@agent-swarm.dev"
            git add swarms/*/swarm.yaml
            git commit -m "chore: Auto-update task tracking for $SWARM/$TASK"
            git push
          fi
        else
          echo "No tracking tags found in commit message"
        fi

    - name: Notify Operations Swarm
      if: success()
      run: |
        # Create notification file for Operations Swarm
        TIMESTAMP=$(date -u +"%Y-%m-%d_%H-%M-%S")
        mkdir -p swarms/operations/notifications
        cat > "swarms/operations/notifications/${TIMESTAMP}_tracking_update.txt" << EOF
Automated Tracking Update
Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
Trigger: Git push to ${GITHUB_REF}
Commit: ${GITHUB_SHA}
Updated: Check swarms/*/swarm.yaml for changes
EOF

        if [ -f "swarms/operations/notifications/${TIMESTAMP}_tracking_update.txt" ]; then
          git config user.name "Agent Swarm Bot"
          git config user.email "bot@agent-swarm.dev"
          git add "swarms/operations/notifications/${TIMESTAMP}_tracking_update.txt"
          git commit -m "chore: Notify Operations of tracking update" || true
          git push || true
        fi
